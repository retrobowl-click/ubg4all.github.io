var SPP=SPP||{REVISION:"Release1.0",AUTHOR:"flashhawk",BLOG:"flashquake.cn",github:"https://github.com/flashhawk",weibo:"http://weibo.com/flashawk"};SPP.frameTime=0,SPP.inherit=function(t,e){t.superClass=e,t.prototype=Object.create(e.prototype),t.prototype.constructor=t},SPP.extend=function(t,e){if(!e||"object"!=typeof e)return t;for(var i=Object.keys(e),o=i.length;o--;)t[i[o]]=e[i[o]];return t},function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(e,i){var o=Date.now(),n=Math.max(0,16-(o-t)),s=window.setTimeout(function(){e(o+n)},n);return t=o+n,s}),window.cancelAnimationFrame=window.cancelAnimationFrame||function(t){window.clearTimeout(t)}}(),SPP.MathUtils=function(){},SPP.MathUtils.toDegree=function(t){return t/Math.PI*180},SPP.MathUtils.toRadian=function(t){return t/180*Math.PI},SPP.MathUtils.sinD=function(t){return Math.sin(SPP.MathUtils.toRadian(t))},SPP.MathUtils.asinD=function(t){return SPP.MathUtils.toDegree(Math.asin(t))},SPP.MathUtils.cosD=function(t){return Math.cos(SPP.MathUtils.toRadian(t))},SPP.MathUtils.acosD=function(t){return SPP.MathUtils.toDegree(Math.acos(t))},SPP.MathUtils.tanD=function(t){return Math.tan(SPP.MathUtils.toRadian(t))},SPP.MathUtils.atanD=function(t){return SPP.MathUtils.toDegree(Math.atan(t))},SPP.MathUtils.atan2D=function(t,e){return SPP.MathUtils.toDegree(Math.atan2(t,e))},SPP.MathUtils.random=function(t){return t*Math.random()>>0},SPP.Event=function(t){this.type=t,this.target=null},SPP.Event.prototype={constructor:SPP.Event,clone:function(){return new SPP.Event(this.type,this.target)}},SPP.EventDispatcher=function(){},SPP.EventDispatcher.prototype={constructor:SPP.EventDispatcher,apply:function(t){t.addEventListener=SPP.EventDispatcher.prototype.addEventListener,t.removeEventListener=SPP.EventDispatcher.prototype.removeEventListener,t.removeAllEventListeners=SPP.EventDispatcher.prototype.removeAllEventListeners,t.dispatchEvent=SPP.EventDispatcher.prototype.dispatchEvent,t.on=SPP.EventDispatcher.prototype.addEventListener,t.once=SPP.EventDispatcher.prototype.once},addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},dispatchEvent:function(t){if(void 0!==this._listeners&&void 0!=(e=this._listeners[t.type])){t.target=this;for(var e,i=0,o=(e=e.slice()).length;i<o;i++)e[i].call(this,t)}},removeEventListener:function(t,e){if(void 0!==this._listeners){var i=this._listeners;i[t]&&(d=i[t].indexOf(e),-1!==d&&i[t].splice(d,1))}},removeAllEventListeners:function(){if(void 0!==this._listeners){var t,e=this._listeners;for(t in e)delete e[t]}}},SPP.EventDispatcher.prototype.on=SPP.EventDispatcher.prototype.addEventListener,SPP.EventDispatcher.prototype.once=function(t,e){this.addEventListener(t,function i(o){this.removeEventListener(t,i),e.call(this,o)})},SPP.Rectangle=function(t,e,i,o){this.x=t||0,this.y=e||0,this.width=i||0,this.height=o||0},SPP.Rectangle.prototype={constructor:SPP.Rectangle,top:function(){return this.y},bottom:function(){return this.y+this.height},left:function(){return this.x},right:function(){return this.x+this.width},topLeft:function(){return new SPP.Point(this.x,this.y)},bottomRight:function(){return new SPP.Point(this.right(),this.bottom())},clone:function(){return SPP.Rectangle(this.x,this.y,this.width,this.height)},toString:function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]"}},SPP.Vector2D=function(t,e){this.x=t||0,this.y=e||0},SPP.Vector2D.prototype={constructor:SPP.Vector2D,toString:function(){return"[Vector2D (x="+this.x+" y="+this.y+")]"},clone:function(){return new SPP.Vector2D(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},reset:function(t,e){return this.x=t||0,this.y=e||0,this},equals:function(t){return this.x==t.x&&this.y==t.y},add:function(t){return this.x+=t.x,this.y+=t.y,this},addNew:function(t){return new SPP.Vector2D(this.x+t.x,this.y+t.y)},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},sub:function(t){return this.x-=t.x,this.y-=t.x,this},subNew:function(t){return new SPP.Vector2D(this.x-t.x,this.y-t.y)},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},negate:function(){return this.x*=-1,this.y*=-1,this},negateX:function(){return this.x*=-1,this},negateY:function(){return this.y*=-1,this},negateNew:function(){return new SPP.Vector2D(-this.x,-this.y)},scale:function(t){return this.x*=t,this.y*=t,this},scaleX:function(t){return this.x*=t,this},scaleY:function(t){return this.y*=t,this},scaleNew:function(t){return new SPP.Vector2D(this.x*t,this.y*t)},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},setLength:function(t){return t/=this.getLength(),this.scale(t),this},getAngle:function(){return SPP.MathUtils.atan2D(this.y,this.x)},setAngle:function(t){var e=this.getLength();return this.x=e*SPP.MathUtils.cosD(t),this.y=e*SPP.MathUtils.sinD(t),this},rotate:function(t){var e=SPP.MathUtils.sinD(t);t=SPP.MathUtils.cosD(t);var i=this.x,o=this.y;return this.x=i*t-o*e,this.y=i*e+o*t,this},rotateNew:function(t){var e=this.clone();return e.rotate(t),e},dot:function(t){return this.x*t.x+this.y*t.y},projection:function(t){var e=this.angleBetween(t);return e=this.getLength()*SPP.MathUtils.cosD(e)/t.getLength(),t.scaleNew(e)},normalizeNew:function(){return this.clone().normalize()},normalize:function(){return 0!=this.getLength()?this.scale(1/this.getLength()):this.scale(0),this},getNormal:function(){return new SPP.Vector2D(-this.y,this.x)},isPerpTo:function(t){return 0==this.dot(t)},angleBetween:function(t){return t=this.dot(t)/(this.getLength()*t.getLength()),SPP.MathUtils.acosD(t)},distanceTo:function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}},SPP.VectorPool={__vectors:[],get:function(){return 0<this.__vectors.length?this.__vectors.pop():this._addToPool()},recycle:function(t){t.reset(0,0),this.__vectors.push(t)},_addToPool:function(){for(var t=0;50>t;t++)this.__vectors.push(new SPP.Vector2D);return new SPP.Vector2D}},SPP.Particle=function(){this.group=null,this.life=1/0,this._forcesMap={},this.extra={},this.zone=this.onUpdate=null},SPP.Particle.prototype={constructor:SPP.Particle,init:function(t,e,i){0>=i&&(i=-1/0),this.position=SPP.VectorPool.get(),this.velocity=SPP.VectorPool.get(),this.acceleration=SPP.VectorPool.get(),this.damp=SPP.VectorPool.get(),this.damp.reset(.1,.1),this.life=i||1/0,this.position.reset(t,e)},getForce:function(t){return this._forcesMap[t]},addForce:function(t,e){this._forcesMap[t]=e},removeForce:function(t){this._forcesMap[t].target===this&&(this._forcesMap[t].life=0),delete this._forcesMap[t]},removeAllForces:function(){for(var t in this._forcesMap)this.removeForce(t)},render:function(){if(this.update(),this.onUpdate&&this.onUpdate.apply(this),null!=this.group){var t,e=this.group.getForceMap();for(t in e)e[t].render(this)||delete e[t]}for(t in this._forcesMap)this._forcesMap[t].render(this)||this.removeForce(t);this.velocity.add(this.acceleration),this.acceleration.reset(0,0),this.velocity.x*=1-this.damp.x,this.velocity.y*=1-this.damp.y,this.position.add(this.velocity),this.zone&&this.zone.render(this),this.life-=SPP.frameTime,0<=this.life||(this.dispatchEvent(new SPP.Event("dead")),this.reset())},update:function(){},dealloc:function(){SPP.VectorPool.recycle(this.position),SPP.VectorPool.recycle(this.velocity),SPP.VectorPool.recycle(this.acceleration),SPP.VectorPool.recycle(this.damp),this.group=this.zone=this.onUpdate=this.extra=this._forcesMap=this.life=this.damp=this.acceleration=this.velocity=this.position=null},reset:function(){for(var t in SPP.VectorPool.recycle(this.position),SPP.VectorPool.recycle(this.velocity),SPP.VectorPool.recycle(this.acceleration),SPP.VectorPool.recycle(this.damp),this.damp=this.acceleration=this.velocity=this.position=null,this.life=0,this.removeAllForces(),this.removeAllEventListeners(),this.extra)delete this.extra[t];this.group=this.zone=this.onUpdate=null}};var testtimes=0;SPP.extend(SPP.Particle.prototype,SPP.EventDispatcher.prototype),SPP.Pool=function(){var t=[];this.get=function(e){for(var i in t)if(t[i].constructor===e)return t.splice(i,1)[0];return new e},this.recycle=function(e){t.length<50&&t.push(e)},this.getObjects=function(){return t},this.dealloc=function(){for(var e=0,i=t.length;e<i;e++)t[e].dealloc();t.length=0,t=null}},SPP.forcePool=new SPP.Pool,SPP.particlePool=new SPP.Pool,SPP.Group=function(t){var e=t,i={};this.createParticle=function(t){return(t=e.createParticle(t)).group=this,t},this.getForceMap=function(){return i},this.addForce=function(t,e){i[t]=e},this.removeForce=function(t){delete i[t]},this.removeAllForces=function(){for(var t in i)delete i[t]},this.dealloc=function(){this.removeAllForces(),i=e=null}},SPP.ParticleSystem=function(){var t=[],e=[],i=[],o=null,n=!1;this.getParticles=function(){return t},this.getForces=function(){return e},this.createParticle=function(e){return e=SPP.particlePool.get(e),t.push(e),e},this.createForce=function(t){return t=SPP.forcePool.get(t),e.push(t),t},this.createGroup=function(){var t=new SPP.Group(this);return i.push(t),t},this.destroyGroup=function(e){var o=i.indexOf(e);if(-1!=o){for(var n=t.length;0<n--;)t[n].parent===e&&(SPP.particlePool.recycle(t[n]),t.splice(n,1));i.splice(o,1),e.dealloc()}},this.destroyAllGroup=function(){for(var e=t.length;0<e--;)null!=t[e].parent&&(SPP.particlePool.recycle(t[e]),t.splice(e,1));var o=0;for(e=i.length;o<e;o++)i[o].dealloc();i.length=0},this.render=function(){if(n){SPP.frameTime=.001*(Date.now()-o),o=Date.now();for(var i=t.length,s=0;s<i;s++)t[s].render();for(;0<i--;)0>=t[i].life&&(SPP.particlePool.recycle(t[i]),t.splice(i,1));for(i=e.length;0<i--;)0>=e[i].life&&(SPP.forcePool.recycle(e[i]),e.splice(i,1))}},this.start=function(){o=Date.now(),n=!0},this.stop=function(){n=!1},this.destroy=function(){this.stop(),n=o=null;for(var s=0,r=t.length;s<r;s++)t[s].dealloc();for(s=0,r=i.length;s<r;s++)i[s].dealloc();for(s=0,r=e.length;s<r;s++)e[s].dealloc();i.length=0,i=null,e.length=0,e=null,t.length=0,t=null}},SPP.Zone=function(t,e){this.boundary=t||null,this.type=e||SPP.Zone.OFFSCREEN,this.bounceIntensity=2},SPP.Zone.OFFSCREEN="_offscreen",SPP.Zone.BOUNCE="_bounce",SPP.Zone.prototype={constructor:SPP.Zone,render:function(t){this[this.type](t)},_bounce:function(t){(t.position.x<this.boundary.left()||t.position.x>this.boundary.right())&&(t.position.x=t.position.x<this.boundary.left()?this.boundary.left():this.boundary.right(),t.velocity.scaleX(-this.bounceIntensity)),(t.position.y<this.boundary.top()||t.position.y>this.boundary.bottom())&&(t.position.y=t.position.y<this.boundary.top()?this.boundary.top():this.boundary.bottom(),t.velocity.scaleY(-this.bounceIntensity)),t.acceleration.scale(0)},_offscreen:function(t){t.position.x<this.boundary.left()&&(t.position.x=this.boundary.right()),t.position.x>this.boundary.right()&&(t.position.x=this.boundary.left()),t.position.y<this.boundary.top()&&(t.position.y=this.boundary.bottom()),t.position.y>this.boundary.bottom()&&(t.position.y=this.boundary.top())}},SPP.Force=function(){this.value=SPP.VectorPool.get(),this.life=1/0,this.target=null},SPP.Force.prototype={constructor:SPP.Force,init:function(t,e,i){this.value.reset(t,e),this.life=i||1/0},render:function(t){return this.update(t),!(0>(this.life-=SPP.frameTime)&&(this.dispatchEvent(new SPP.Event("dead")),this.reset(),1))},update:function(t){t.acceleration.add(this.value)},dealloc:function(){this.value=null,this.life=void 0,this.target=null},reset:function(){SPP.VectorPool.recycle(this.value),this.life=1/0,this.target=null}},SPP.extend(SPP.Force.prototype,SPP.EventDispatcher.prototype),SPP.Attraction=function(){SPP.Force.call(this)},SPP.inherit(SPP.Attraction,SPP.Force),SPP.Attraction.prototype.init=function(t,e,i,o){SPP.Force.prototype.init.call(this,0,0,o),this.maxValue=e,this.r=i,this.attractionPosition=t},SPP.Attraction.prototype.update=function(t){this.attractionPosition.distanceTo(t.position)<this.r?this.value.reset(0,0):(this.value.subVectors(this.attractionPosition,t.position),this.value.normalize().setLength(this.maxValue)),t.acceleration.add(this.value)},SPP.Attraction.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this),this.r=this.maxValue=void 0,this.attractionPosition=null},SPP.Attraction.prototype.reset=function(){SPP.Force.prototype.reset.apply(this),this.r=this.maxValue=void 0,this.attractionPosition=null},SPP.Brownian=function(){SPP.Force.call(this)},SPP.inherit(SPP.Brownian,SPP.Force),SPP.Brownian.prototype.init=function(t,e,i){SPP.Force.prototype.init.call(this,0,0,i),this.maxValue=t,this.cycle=e,this.pastTime=0,this.value.reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue)},SPP.Brownian.prototype.update=function(t){this.pastTime+=SPP.frameTime,this.pastTime>=this.cycle&&(this.value.reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue),this.pastTime=0),t.acceleration.add(this.value)},SPP.Brownian.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this),this.pastTime=this.cycle=this.maxValue=void 0},SPP.Brownian.prototype.reset=function(){SPP.Force.prototype.reset.apply(this),this.pastTime=this.cycle=this.maxValue=void 0},SPP.SimpleBrownian=function(){SPP.Force.call(this)},SPP.inherit(SPP.SimpleBrownian,SPP.Force),SPP.SimpleBrownian.prototype.init=function(t,e){SPP.Force.prototype.init.call(this,0,0,e),this.maxValue=t},SPP.SimpleBrownian.prototype.update=function(t){this.value.reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue),t.acceleration.add(this.value)},SPP.SimpleBrownian.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this),this.cycle=this.maxValue=void 0},SPP.SimpleBrownian.prototype.reset=function(){SPP.Force.prototype.reset.apply(this),this.cycle=this.maxValue=void 0},SPP.Repulsion=function(){SPP.Force.call(this)},SPP.inherit(SPP.Repulsion,SPP.Force),SPP.Repulsion.prototype.init=function(t,e,i,o){SPP.Force.prototype.init.call(this,0,0,o),this.maxValue=e,this.r=i,this.repulsionPosition=t},SPP.Repulsion.prototype.update=function(t){this.repulsionPosition.distanceTo(t.position)>this.r?this.value.reset(0,0):(this.value.subVectors(t.position,this.repulsionPosition),this.value.normalize().setLength(this.maxValue)),t.acceleration.add(this.value)},SPP.Repulsion.prototype.dealloc=function(){SPP.Force.prototype.dealloc.apply(this),this.r=this.maxValue=void 0,this.repulsionPosition=null},SPP.Repulsion.prototype.reset=function(){SPP.Force.prototype.reset.apply(this),this.r=this.maxValue=void 0,this.repulsionPosition=null},SPP.SpriteImage=function(){SPP.Particle.call(this),this.texture=this.context=null,this.scale=1,this.rotation=0,this.alpha=1,this.regY=this.regX=.5},SPP.inherit(SPP.SpriteImage,SPP.Particle),SPP.SpriteImage.prototype.update=function(){null==this.context||null==this.texture||(this.context.save(),this.context.alpha=this.alpha,this.context.translate(this.position.x,this.position.y),this.context.rotate(this.rotation),this.context.scale(this.scale,this.scale),this.context.drawTexture(this.texture,-this.texture.width*this.regX,-this.texture.height*this.regY,0,0,null,this.alpha),this.context.restore())},SPP.SpriteImage.prototype.init=function(t,e,i,o,n){SPP.Particle.prototype.init.apply(this,[t,e,i]),this.context=n,this.texture=o},SPP.SpriteImage.prototype.reset=function(){SPP.Particle.prototype.reset.apply(this),this.texture=this.context=null,this.scale=1,this.rotation=0,this.alpha=1,this.regY=this.regX=.5},SPP.SpriteImage.prototype.width=function(){return this.texture.width*this.scale},SPP.SpriteImage.prototype.height=function(){return this.texture.height*this.scale};